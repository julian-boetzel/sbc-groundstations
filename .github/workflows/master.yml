name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - master

env:
  TAG_NAME: latest

jobs:
  buildroot:
    name: Build Firmware (runcam_wifilink)
    runs-on: ubuntu-latest

    steps:
      - name: Display free disk space
        run: df -hT

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Prepare firmware
        run: |
          echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
          echo "CACHE_DATE=$(date +%Y-%m)" >> $GITHUB_ENV
          sudo apt update
          sudo apt install -y cpio rsync bc qemu-user-static binfmt-support
          sudo mkdir -p /mnt/workspace
          sudo chown $USER:$USER /mnt/workspace
          rsync -a "$GITHUB_WORKSPACE/" /mnt/workspace/

      # Cache Buildroot downloads (big win)
      - name: Cache Buildroot downloads
        uses: actions/cache@v4
        with:
          path: /mnt/workspace/buildroot/dl
          key: dl-runcam_wifilink-${{ env.CACHE_DATE }}
          restore-keys: |
            dl-runcam_wifilink-

      # Cache Buildroot output dir (toolchain + package build artifacts)
      - name: Cache Buildroot output
        uses: actions/cache@v4
        with:
          path: /mnt/workspace/output/runcam_wifilink_defconfig
          key: out-runcam_wifilink-${{ env.CACHE_DATE }}
          restore-keys: |
            out-runcam_wifilink-

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: /tmp/ccache
          key: ccache-runcam_wifilink-${{ env.CACHE_DATE }}
          restore-keys: |
            ccache-runcam_wifilink-

      - name: Build firmware
        working-directory: /mnt/workspace
        run: |
          set -euo pipefail

          export GIT_HASH=$(git rev-parse --short $GITHUB_SHA)
          export GIT_BRANCH=${GITHUB_REF_NAME}
          echo "GIT_HASH=${GIT_HASH}" >> $GITHUB_ENV
          echo "GIT_BRANCH=${GIT_BRANCH}" >> $GITHUB_ENV

          mkdir -p /tmp/ccache
          ln -sf /tmp/ccache ${HOME}/.ccache
          export CCACHE_DIR=/tmp/ccache
          export PATH="/usr/lib/ccache:$PATH"
          ccache -z || true

          NAME=runcam_wifilink
          DEFCONFIG=${NAME}_defconfig bash build.sh all

          ccache -s || true

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: runcam_wifilink-${{ github.sha }}
          path: |
            /mnt/workspace/output/runcam_wifilink_defconfig/images/runcam_wifilink_sdcard.img
            /mnt/workspace/output/runcam_wifilink_defconfig/images/runcam_wifilink.tar.gz
          retention-days: 7

  release-on-master:
    name: Release Snapshot (master)
    runs-on: ubuntu-latest
    needs: [buildroot]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master' && !startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create/Update Snapshot Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: buildroot-snapshot
          body: |
            Snapshot build from master
            Commit: ${{ github.sha }}
          files: artifacts/**/*
          prerelease: true
          overwrite: true

  release-on-tag:
    name: Release Version (tag)
    runs-on: ubuntu-latest
    needs: [buildroot]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Versioned Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            Stable release ${{ github.ref_name }}
            Commit: ${{ github.sha }}
          files: artifacts/**/*
          draft: false
          prerelease: false
